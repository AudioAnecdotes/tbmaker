#!/usr/bin/perl

sub doManifest()
{
	my $MANIFEST="manifest";
	my $DISTTYPE="";
	my $TARLOCS="";
	my $TMPDIR="";
	$argc=scalar(@ARGV);
	$dir=`pwd`;
	if ($argc == 3)
	{
                print "args = @ARGV\n";

		$DISTTYPE=$ARGV[0];
		$TARLOCS=$ARGV[1];
		$TMPDIR=$ARGV[2];
	}
	else
	{
		print STDERR "tbmaker expects 3 arguments!\n";
		exit -1;
	}
	if (!open(FILE,"<$MANIFEST"))
	{
		print STDERR "Can't open manifest file $MANIFEST\n";
		exit -1;
	}

	print "Reading manifest from file $MANIFEST in directory $dir\n";

	LINELOOP: while ($line=<FILE>)
	{
		# skip blank lines
		next LINELOOP if ($line eq '');

		# skip comments (#) and works-in-process (^)
		next LINELOOP if (substr($line,0,1) eq "#");
		next LINELOOP if (substr($line,0,1) eq "^");

		# split fields on whitespace
		@parts=split(/\s+/,$line);

		if (@parts[0] eq "$DISTTYPE")
		{
			print "processing: $line\n";
			if (!&processLine(@parts[1],"$TARLOCS@parts[2]",@parts[3],$TMPDIR))
			{
				print "\tError processing line\n";
				exit -1;
			}
		}
	}
        continue {
		if ($line eq '') { print "ignoring blank line\n"; }
		if (substr($line,0,1) eq "#") { print "ignoring comment: $line\n"; }
		if (substr($line,0,1) eq "^") { print "ignoring pending: $line\n"; }
        }
	return 0;
}

sub processLine($$$$)
{
	my ($local,$tar,$install,$tmploc)=@_;
	if (length($local)==0 || length($tar)==0 || length($install)==0)
	{
		return 1;
	}
	@dirparts=split(/\//,$install);
	$p="";
	for ($i=0;$i<scalar(@dirparts)-1;$i++)
	{
		$p="$p@dirparts[$i]/";
	}

	$mkdircmd="mkdir -p $tmploc/$p 2>&1";
	$throwaway=`$mkdircmd`;


## problems with "cat":
## 1. can't find ./copyright whether it's in aadevtree/ or aadevtree/bin
## 2. shouldn't include "config.child.make.inc" (finds embedded ".c")
##
## other problems:
## 1. from aadevtree, "make dist-src" crashes here:
##    	make[1]: Entering directory `/cvsroot/aadevtree/src'
##    	make[1]: Leaving directory `/cvsroot/aadevtree/src'
##	make[1]: *** No rule to make target `dist'.  Stop.
##	make: *** [dist-src] Error 2


##	# copy file to tmp dir for tarring; source files get a copr notice prepended
##	if ($local =~ m/\.(c|cpp|h)/) {
##		$cpcmd="cat ./copyright $local > $tmploc/$install 2>&1"; 
##	} else {
		$cpcmd="cp -f $local $tmploc/$install 2>&1";
##	}
	$errors=`$cpcmd`;
	if ($errors) { 
		print "cp or cat err on file: $local\n"; 
		return !length($errors);
	}

	# all files (especially src) need to be writable
	$chcmd="chmod a+w $tmploc/$install 2>&1";
	$throwaway=`$chcmd`;

	# debugging info	
	#print "cp -f $local $tmploc/$install \n";
	print "$cpcmd \n";
	print "\tAdding file $local to tar file $tar to location $install\n";

	# finally, add file to tarball
	$tarcmd="tar -uf $tar -C $tmploc $install 2>&1";
	$errors=`$tarcmd`;
	if ($errors) { print "tar err on file: $local\n"; }
	return !length($errors);
}

&doManifest();
